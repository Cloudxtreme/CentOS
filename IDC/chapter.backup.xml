<?xml version="1.0" encoding="UTF-8"?>
<chapter id="backup">
	<title>Linux 数据备份</title>
	<section>
		<title>批量差异备份</title>
		<para>/etc/cron.daily/backup</para>
		<screen>
		<![CDATA[
#!/bin/bash
for ip in {23..32} {49,50} {81..92}; do mkdir -p /opt/backup/$ip/srv/; rsync -auz --delete root@172.16.3.$ip:/srv/* /opt/backup/$ip/srv/; done &
for ip in {23..32} {49,50} {81..92}; do mkdir -p /opt/backup/$ip/www/; rsync -auz --delete root@172.16.3.$ip:/www/* /opt/backup/$ip/www/; done &
		]]>
		</screen>
	</section>
	<section id="backup.db">
		<title>mysql备份</title>
		<screen>
		<![CDATA[
#!/bin/bash
###################################
# $Id: chapter.backup.xml 428 2012-06-16 11:12:06Z netkiller $
# Author: netkiller@msn.com
# Home:	http://netkiller.github.com
###################################
# SELECT `user`, `host`, `password` FROM `mysql`.`user`;
# CREATE USER 'backup'@'localhost' IDENTIFIED BY 'SaJePoM6BAPOmOFOd7Xo3e1A52vEPE';
# GRANT SELECT, LOCK TABLES  ON *.* TO 'backup'@'localhost';
# FLUSH PRIVILEGES;
# SHOW GRANTS FOR 'backup'@'localhost';
###################################
BACKUP_HOST="localhost"
BACKUP_USER="backup"
BACKUP_PASS="PA3nScWWdqC3Ww4KPu"
BACKUP_DIR=/opt/backup
BACKUP_DBNAME="dbname"
#Number of copies
COPIES=30
####################################
MYSQLDUMP="/usr/bin/mysqldump"
TIMEPOINT=$(date -u +%Y-%m-%d)
MYSQLDUMP_OPTS="-h $BACKUP_HOST -u$BACKUP_USER -p$BACKUP_PASS"
####################################
test ! -w $BACKUP_DIR && echo "Error: $BACKUP_DIR is un-writeable." && exit 0

umask 0077

for dbname in $BACKUP_DBNAME
do
	test ! -d "$BACKUP_DIR/$dbname" && mkdir -p "$BACKUP_DIR/$dbname"

	$MYSQLDUMP $MYSQLDUMP_OPTS $dbname | gzip > $BACKUP_DIR/$dbname/$dbname.$TIMEPOINT.sql.gz
done
find $BACKUP_DIR -type f -mtime +$COPIES -delete
		]]>
		</screen>
	</section>
</chapter>

